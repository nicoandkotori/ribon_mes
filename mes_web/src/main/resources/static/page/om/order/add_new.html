<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>新增</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../../static/css/font.css">
    <link rel="stylesheet" href="../../../static/css/weadmin.css">
    <!-- jqgrid -->
    <link rel="stylesheet" href='../../../static/Scripts/jqgrid/css/jquery-ui.theme.min.css'/>
    <link rel="stylesheet" href='../../../static/Scripts/jqgrid/css/ui.jqgrid.css'/>
    <!-- bootstrap -->
    <link rel="stylesheet" href="../../../static/css/bootstrap.min.css">
    <!-- datepicker -->
    <link rel="stylesheet" href='../../../static/Scripts/datepicker/bootstrap-datetimepicker.css'/>
    <link rel="stylesheet" href='../../../static/Scripts/datepicker/bootstrap-datepicker.min.css'/>
    <!--easyui-->
    <link rel="stylesheet" href="../../../static/Scripts/easyui-1.7.0/themes/default/easyui.css">
    <link rel="stylesheet" href="../../../static/Scripts/easyui-1.7.0/themes/icon.css">

    <!--jquery-->
    <script src='../../../static/Scripts/jquery-1.10.2.min.js'></script>
    <script src='../../../static/Scripts/jquery.json.js'></script>
    <script src='../../../static/Scripts/Common.js'></script>
    <script src='../../../static/Scripts/Print.js'></script>
    <script src='../../../static/Scripts/lodop/LodopFuncs.js'></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="../../../lib/layui/layui.js" charset="utf-8"></script>
    <script src="../../../static/js/eleDel.js" type="text/javascript" charset="utf-8"></script>
    <!--jqgrid-->
    <script src='../../../static/Scripts/jqgrid/js/i18n/grid.locale-cn.js'></script>
    <script src='../../../static/Scripts/jqgrid/js/jquery-ui.min.js'></script>
    <script src='../../../static/Scripts/jqgrid/js/jquery.jqGrid.js'></script>
    <!-- datepicker -->
    <script src='../../../static/Scripts/datepicker/bootstrap-datepicker.js'></script>
    <script src='../../../static/Scripts/datepicker/bootstrap-datepicker.zh-CN.js'></script>
    <script src='../../../static/Scripts/datepicker/bootstrap-datetimepicker.js'></script>
    <script src='../../../static/Scripts/datepicker/bootstrap-datetimepicker.zh-CN.js'></script>
    <!--easyui-->
    <script src="../../../static/Scripts/easyui-1.7.0/jquery.easyui.min.js"></script>
    <script src="../../../static/Scripts/easyui-1.7.0/locale/easyui-lang-zh_CN.js"></script>
    <script src="constConfig.js"></script>
    <script src="entity/OmMesProduct.js"></script>
    <script src="entity/OmMesPart.js"></script>
    <script src="entity/OmMesMaterial.js"></script>
    <script src="function.js"></script>
    <script src="jqGridRowHelper.js"></script>
    <script src="dto/U8QueryDTO.js"></script>
    <style>
        .layui-select, .layui-input {
            height: 24px;
        }
    </style>
</head>

<body>
<div class="weadmin-body">
    <form class="layui-form">
        <div class="weadmin-block">
            <button type="button" class="layui-btn layui-btn-sm" onclick="continueAdd()">新增</button>
            <button type="button" class="layui-btn layui-btn-sm" lay-filter="save" lay-submit="">保存</button>
            <button type="button" class="layui-btn layui-btn-sm" onclick="FnCheck()">审核</button>
            <button type="button" class="layui-btn layui-btn-sm" onclick="FnUnCheck()">弃审</button>
            <button type="button" class="layui-btn layui-btn-sm" onclick="FnPrint()">打印</button>

        </div>


        <div class="layui-form-item weadmin-item">
            <input type="hidden" id="id" name="id">

            <label for="vouchCode" class="weadmin-lable-sm layui-col-md1">
                <span class="we-red">*</span>订单编号
            </label>
            <div class="layui-col-md2">
                <input type="text" id="vouchCode" name="vouchCode" readonly class="layui-input weadmin-input-sm">
            </div>
            <label for="vouchDate" class="weadmin-lable-sm layui-col-md1">
                <span class="we-red">*</span>日期
            </label>
            <div class="layui-col-md2">
                <input type="text" id="vouchDate" name="vouchDate" readonly lay-verify="required"
                       class="layui-input weadmin-input-sm">
            </div>
            <label for="contractOm" class="weadmin-lable-sm layui-col-md1">
                委外合同
            </label>
            <div class="layui-col-md2">
                <input type="text" id="contractOm" name="contractOm" class="layui-input weadmin-input-sm">
            </div>
        </div>
        <div class="layui-form-item weadmin-item">

            <label for="venCode" class="weadmin-lable-sm layui-col-md1">
                <span class="we-red">*</span>供应商
            </label>
            <div class="layui-col-md5">
                <select id="venCode" name="venCode" autocomplete="off" lay-verify="required" lay-filter="venCode"
                        lay-search="">
                </select>
                <input type="hidden" id="venName" name="venName">

            </div>
            <label for="contractSale" class="weadmin-lable-sm layui-col-md1">
                销售合同
            </label>
            <div class="layui-col-md2">
                <input type="text" id="contractSale" name="contractSale" class="layui-input weadmin-input-sm">
            </div>

        </div>

        <div class="layui-form-item weadmin-item">

            <label for="depCode" class="weadmin-lable-sm layui-col-md1">
                <span class="we-red">*</span>部门
            </label>
            <div class="layui-col-md2">
                <select id="depCode" name="depCode" autocomplete="off" lay-verify="required" lay-filter="depCode"
                        lay-search="">
                </select>
                <input type="hidden" id="depName" name="depName">

            </div>
            <label for="personCode" class="weadmin-lable-sm layui-col-md1">
                <span class="we-red">*</span>业务员
            </label>
            <div class="layui-col-md2">
                <select id="personCode" name="personCode" autocomplete="off" lay-verify="" lay-filter="personCode"
                        lay-search="">
                </select>
                <input type="hidden" id="personName" name="personName">

            </div>
            <label for="transportWay" class="weadmin-lable-sm layui-col-md1">
                运输方式
            </label>
            <div class="layui-col-md2">

                <div class="layui-inline">
                    <select id="transportWay" name="transportWay" placeholder="" lay-filter="transportWay" lay-search="">
                        <option value=></option>
                        <option value="自提">自提</option>
                        <option value="送货">送货</option>
                    </select>
                </div>
            </div>

        </div>

        <div class="layui-form-item weadmin-item">

            <label for="remark" class="weadmin-lable-sm layui-col-md1">
                备注
            </label>
            <div class="layui-col-md8">
                <input type="text" id="remark" name="remark" autocomplete="off"
                       class="layui-input weadmin-input-sm">
            </div>
        </div>
    </form>
</div>
<div class="weadmin-body-table">
    <button type="button" class="layui-btn layui-btn-sm" onclick="btnAddProductRow()">增行</button>
    <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" onclick="deleteProductRow()">删行</button>
    <button type="button" class="layui-btn layui-btn-sm" onclick="addPart()">添加部件</button>
    <table id="jqGrid"></table>
    <button type="button" class="layui-btn layui-btn-sm" onclick="addMaterialRowEvent()">增行</button>
    <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" onclick="deleteMaterialRow()">删行</button>
    <table id="jqGridDetail"></table>

</div>

</body>
<script>
    var prevEditRow, prevEditCol;
    var baseUrl = "/om/metalworkcommittee/";
    var CurRow;
    var CurCol;
    var CurRow1;
    var CurCol1;
    //产品表当前选中行id
    var selectedProductRowIndex;
    var rowNum = 1;
    //部件表数据map，key是部件表ID，value是部件表数组
    var partDataMap = new Map();
    var array;
    var productHelper = new jqGridRowHelper($('#'+PRODUCT_TABLE_ID));
    var partHelper = new jqGridRowHelper($('#'+PART_TABLE_ID));
    var materialHelper = new jqGridRowHelper($('#'+MATERIAL_TABLE_ID));
    //选择物料的类型，包括'product'和'material'，
    var chooseInvType = '';
    //计划开工日期
    var planStartDate = '';
    //计划结束日期
    var planEndDate = '';
    //向打开的部件窗口传递的参数
    var addPartParams;
    //产品表最大行ID
    var productMaxId = 1;
    //部件表最大行ID
    var partMaxId = 1;
    //材料表最大行ID
    var materialMaxId = 1;
    $(function () {
        initJqgrid();
        // initBtn(".weadmin-block button", "/biz/moplanmain");
    });

    layui.use(['form', 'admin', 'jquery', 'table', 'layer', 'laydate', 'treeSelect', "upload", 'tableSelect'], function () {
        var form = layui.form,
            admin = layui.admin,
            $ = layui.jquery,
            table = layui.table,
            layer = layui.layer,
            laydate = layui.laydate,
            treeSelect = layui.treeSelect,
            upload = layui.upload,
            tableSelect = layui.tableSelect;


        //部门
        laySelect('depCode', '/basicinfo/department/getlist', {}, {id: "cdepcode", text: "cdepname"}, false, form);
        form.on('select(depCode)', function (data) {
            let depName = $("#depCode").find("option:selected").text();
            $("#depName").val(depName);
        });
        //业务员
        laySelect('personCode', '/basicinfo/person/getlist', {}, {
            id: "cpersoncode",
            text: "cpersonname"
        }, false, form);
        form.on('select(personCode)', function (data) {
            let personName = $("#personCode").find("option:selected").text();
            $("#personName").val(personName);
        });

        //供应商
        laySelect('venCode', '/basicinfo/vendor/getlist', {}, {id: "cvencode", text: "cvenname"}, false, form);
        form.on('select(venCode)', function (data) {
            let venName = $("#venCode").find("option:selected").text();
            $("#venName").val(venName);
        });


        initData();


        form.render();
        laydate.render({
            elem: '#vouchDate'
            , value: new Date()
            , theme: 'molv'
        });


        //监听提交
        form.on('submit(save)', function (data) {
            if (CurRow != "" && CurRow != undefined) {
                $("#jqGrid").jqGrid('saveCell', CurRow, CurCol);
            }
            if (CurRow1 != "" && CurRow1 != undefined) {
                $("#jqGridDetail").jqGrid('saveCell', CurRow1, CurCol1);
            }
            var productData = productHelper.getAllRowData();
            var productDataStr = JSON.stringify(productData);
            var materialData = materialHelper.getAllRowData();
            var materialDataStr = JSON.stringify(materialData);
            //map转成一维object数组
            let partDataArray = convertPartDataMapToArray();
            let partDataStr = JSON.stringify(partDataArray);
            let mainId = $("#id").val();
            <!--DATE: 2022/9/16-->
            <!--mijiahao TODO:123 -->
            //订单主表ID为空，则保存
            if (mainId === ""){
                sendPostReq("/om/order/save", {
                    mainStr: JSON.stringify(data.field),
                    productStr: productDataStr,
                    partStr: partDataStr,
                    materialStr: materialDataStr
                }, function (data) {
                    if (data.success == true || data.success == "true") {
                        layer.msg("保存成功", {icon: 6});
                        console.log("保存成功");
                        $("#id").val(data.result);
                        loadAllDataByMainId();
                    } else {
                        layer.msg("保存失败!" + data.msg, {icon: 6});
                    }
                });
            } else {
                loadAllDataByMainId()
            }



        });
    });


    function initData() {
        $.get("/om/metalworkcommittee/getmaxcode", {}, function (text) {
            $("#vouchCode").val(text.result);
        });

        $("#depCode").val("109");
        //部门名称传给后台
        let depName = $("#depCode").find("option:selected").text();
        $("#depName").val(depName);

        sendPostReq("/basicinfo/person/getdefuser", {}, function (data) {
            if (data.result != null) {

                $("#personCode").val(data.result.cpersoncode);
            } else {
                $("#personCode").val("200402009");
            }
            //业务员姓名传给后台
            let personName = $("#personCode").find("option:selected").text();
            $("#personName").val(personName);

        }, false);


    }

    //继续新增
    function continueAdd() {
        if ($('#id').val() == null || $('#id').val() == '') {
            layer.confirm('当前单据未保存, 是否清空当前数据？', function (index) {
                window.location.reload(true);
                layer.close(index);
            });
        } else {
            window.location.reload(true);
        }
    }


    function initJqgrid() {
        $("#jqGrid").jqGrid({
            mtype: "GET",
            datatype: "local",
            colModel: [
                {name: "momaterialsid", hidden: true},
                {name: "modetailsid", key: true, hidden: true},
                {name: ID, hidden: true},
                // {name: RECORD_ID, hidden: true},
                {label:"产品表行标识",name: RECORD_ID,width: 80,sortable: false, editable: true, align: "center"},
                {label: "产品编码", name: PRODUCT_INV_CODE, width: 110, sortable: false, editable: true, align: "center"},
                {label: "产品名称", name: PRODUCT_INV_NAME, width: 90, sortable: false, editable: false, align: "center"},
                {label: "规格型号", name: PRODUCT_INV_STD, width: 80, sortable: false, editable: false, align: "center"},
                {label: "单位", name: PRODUCT_INV_UNIT, width: 40, sortable: false, editable: false, align: "center"},
                {label: "数量", name: PRODUCT_QTY, width: 40, sortable: false, editable: true, align: "center"},
                {label: "材料单价", name: MATERIAL_PRICE, width: 60, sortable: false, editable: false, align: "center"},
                {label: "单件材料费", name: MATERIAL_AMOUNT, width: 70, sortable: false, editable: false, align: "center"},
                {label: "单件加工费（含税）", name: WORK_PRICE, width: 120, sortable: false, editable: true, align: "center"},
                {label: "加工费合计", name: TOTAL_WORK_AMOUNT, width: 70, sortable: false, editable: false, align: "center"},
                {label: "单件价格", name: PRICE, width: 60, sortable: false, editable: true, align: "center"},
                {label: "合计", name: AMOUNT, width: 70, sortable: false, editable: false, align: "center"},
                {label: "税率", name: TAX_RATE, width: 70, sortable: false, editable: true, align: "center"},
                {label: "不含税单价", name: WORK_PRICE_WITHOUT_TAX,hidden: true ,width: 70, sortable: false, editable: true, align: "center"},
                {name: ROW_ID, hidden: true},
                {name: MAIN_ID, hidden: true},
                {
                    label: "计划开工日期",
                    name: PLAN_START_DATE,
                    width: 80,
                    editable: true,
                    sortable: false,
                    align: "center",
                    datefmt: 'yyyy-mm-dd',
                    editoptions: {
                        dataInit: function (e) {
                            $(e).datepicker({
                                todayHighlight: true,
                                language: "zh-CN",//语言
                                autoclose: true,//自动关闭
                                todayBtn: "linked",//
                                format: "yyyy-mm-dd",//时间显示格式
                            }).on('changeDate',function(e){
                                let dateObj = e.date;
                                //转换为年月日
                                let time = dateObj.getFullYear()+"-"+(dateObj.getMonth()+1)+"-"+dateObj.getDate();
                                planStartDate = time;
                            });

                            $(this).click(function (e) {//选中时间后隐藏
                                $(e).parent().datepicker('hide');
                            });
                        }
                    }
                },
                {
                    label: "计划完工日期",
                    name: PLAN_END_DATE,
                    width: 80,
                    editable: true,
                    sortable: false,
                    align: "center",
                    datefmt: 'yyyy-mm-dd',
                    editoptions: {
                        dataInit: function (e) {
                            $(e).datepicker({
                                todayHighlight: true,
                                language: "zh-CN",//语言
                                autoclose: true,//自动关闭
                                todayBtn: "linked",//
                                format: "yyyy-mm-dd"//时间显示格式
                            }).on('changeDate',function(e){
                                let dateObj = e.date;
                                //转换为年月日
                                let time = dateObj.getFullYear()+"-"+(dateObj.getMonth()+1)+"-"+dateObj.getDate();
                                planEndDate = time;
                            });
                            $(this).click(function (e) {//选中时间后隐藏
                                $(e).parent().datepicker('hide');
                            });
                        }
                    }
                },

            ],
            subGrid: true,
            subGridRowExpanded: function (subgrid_id, row_id) {
                // we pass two parameters
                // subgrid_id is a id of the div tag created within a table
                // the row_id is the id of the row
                // If we want to pass additional parameters to the url we can use
                // the method getRowData(row_id) - which returns associative array in type name-value
                // here we can easy construct the following
                var subgrid_table_id, pager_id;
                subgrid_table_id = subgrid_id + "_t";
                pager_id = "p_" + subgrid_table_id;
                $("#" + subgrid_id).html("<table id='" + subgrid_table_id + "' class='scroll'></table><div id='" + pager_id + "' class='scroll'></div>");
                var rwdata = $("#jqGrid").getRowData(row_id);
                $("#" + subgrid_table_id).jqGrid({
                    datatype: "json",
                    method: "post",
                    colModel: [
                        // {name: RECORD_ID, hidden: true},
                        {label:"产品表行标识",name: RECORD_ID,width: 80,sortable: false, editable: true, align: "center",hidden:INDEX_HIDDEN},
                        {label: "部件表行标识",name: PART_ROW_ID, width: 80,hidden:INDEX_HIDDEN},
                        {label: "部件编码", name: PART_INV_CODE, width: 110, sortable: false, editable: true, align: "center"},
                        {label: "部件名称", name: PART_INV_NAME, width: 90, sortable: false, editable: false, align: "center"},
                        {label: "规格型号", name: PART_INV_STD, width: 80, sortable: false, editable: false, align: "center"},
                        {label: "单位", name: PART_INV_UNIT, width: 40, sortable: false, editable: false, align: "center"},
                        {label: "数量", name: PART_QTY, width: 40, sortable: false, editable: true, align: "center"},
                        {name: DETAIL_ID, hidden: true},
                        {name: ROW_ID, hidden: true},
                        {name: MAIN_ID, hidden: true},
                        {name: ID, hidden: true},
                    ],
                    cmTemplate: {sortable: false, align: "center"},
                    pager: false,
                    height: '100%',
                    rowNum: 500,
                    rowList: [20, 50, 100],
                    multiselect: false,
                    //双击事件
                    ondblClickRow: function (rowid, iRow, iCol, e) {
                        var partRwdata = $("#" + subgrid_table_id).getRowData(rowid);

                    },
                    //右键事件
                    onRightClickRow: function (rowid, iRow, iCol, e) {

                    }
                });
                //加载二级表的数据
                let partDataArray = partDataMap.get(subgrid_table_id);

                if (partDataArray != null && partDataArray != undefined){
                    //不打印这行，for里的length读不出数据
                    console.log(partDataArray.length);
                    for ( var i = 0; i < partDataArray.length; i++){
                        $("#"+subgrid_table_id).jqGrid('addRowData', i + 1,partDataArray[i]);
                    }
                }


            },
            viewrecords: true,
            multiselect: false,
            autowidth: true,
            shrinkToFit: false,
            autoScroll: true,
            scrollrows: true, // 是否显示行滚动条
            rownumbers: true,
            rowNum: 999999999,
            colMenu: false,
            cellEdit: true,
            cellsubmit: 'clientArray',
            footerrow: false,//分页上添加一行，用于显示统计信息
            beforeProcessing: function (data, st, xhr) {//登录失效时请求将被拦截，提示用户：未登录
                if (data.success == false) {
                    layer.msg(data.msg);
                }
                return true;
            },
            loadBeforeSend: function (jqXHR) {
                var token = sessionStorage.getItem("mestoken");
                jqXHR.setRequestHeader('Authorization', token);

            },
            ondblClickRow: function (rowid, iRow, iCol, e) {
                //iCol==6||
                if (iCol == 5 || iCol == 6 || iCol == 7) {
                    //选择母件
                    chooseInvType = 'product'
                    choice(rowid);
                }

            },

            loadComplete: function () {


            },
            afterSaveCell: function (rowid, name, val, iRow, iCol) {
                //同步更新所有开始日期
                if (name == PLAN_START_DATE) {
                    var ids = productHelper.getAllRowsId();
                    let productObj = new omMesProduct();
                    for (var i = 0; i < ids.length; i++) {
                        productObj.setEntity(productHelper.getRowDataById(ids[i]));
                        productObj.setPlanStartDate(val);
                        productHelper.setRowDataById(ids[i],productObj);
                    }

                }
                //同步更新所有结束日期
                if (name == PLAN_END_DATE) {
                    let ids = productHelper.getAllRowsId();
                    let productObj = new omMesProduct();
                    for (var i = 0; i < ids.length; i++) {
                        productObj.setEntity(productHelper.getRowDataById(ids[i]));
                        productObj.setPlanEndDate(val);
                        productHelper.setRowDataById(ids[i],productObj);
                    }

                }
                if (name == PRODUCT_INV_CODE) {
                    SetInventory(rowid, "1");
                } else if (name == PRODUCT_QTY) {
                    console.log("修改了数量！");
                     updateProductQty(rowid);
                } else if (name == WORK_PRICE || name == MATERIAL_AMOUNT) {
                     updatePrice(rowid);
                     updateTotalWorkAmount(rowid);
                } else if (name == PRICE){
                    updateAmount(rowid);
                }

            },
            onCellSelect: function (rowid, iCol, cellcontent, e) { //单击选择行
                selectedProductRowIndex = rowid;

            },
            beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
                console.log("开始编辑单元格");
                CurRow = iRow;
                CurCol = iCol;

            },
            gridComplete: function () {

            }
        });


        $("#jqGrid").setGridHeight((150));


        $("#jqGridDetail").jqGrid({
            mtype: "GET",
            datatype: "local",
            colModel: [
                {name: "momaterialsid", key: true, hidden: true},
                {name: ID, hidden: true},
                {label:'产品表行标识',name: RECORD_ID, hidden: INDEX_HIDDEN,width: 80},
                {label:"部件表行表示",name: PART_ROW_ID, hidden: INDEX_HIDDEN,width: 80},
                {label: "产品编码", name: PRODUCT_INV_CODE, width: 110, sortable: false, editable: false, align: "center"},
                {label: "产品名称", name: PRODUCT_INV_NAME, width: 90, sortable: false, editable: false, align: "center"},
                {label: "规格型号", name: PRODUCT_INV_STD, width: 80, sortable: false, editable: false, align: "center"},
                {label: "单位", name: PRODUCT_INV_UNIT, width: 40, sortable: false, editable: false, align: "center"},
                {label: "产品数量", name: PRODUCT_QTY, width: 70, sortable: false, editable: false, align: "center"},
                {label: "规格型号", name: PART_INV_STD, width: 80, sortable: false, editable: false, align: "center"},
                {label: "单位", name: PART_INV_UNIT, width: 40, sortable: false, editable: false, align: "center"},
                {label: "材料单价", name: UNIT_MATERIAL_PRICE, width: 60, sortable: false, editable: true, align: "center"},
                {label: "单件材料费", name: UNIT_MATERIAL_AMOUNT, width: 70, sortable: false, editable: true, align: "center"},
                {label: "材料编码", name: INV_CODE, width: 90, sortable: false, editable: true, align: "center"},
                {label: "材料名称", name: INV_NAME, width: 120, sortable: false, editable: false, align: "center"},
                {label: "材料规格", name: INV_STD, width: 80, sortable: false, editable: false, align: "center"},
                {label: "厚度", name: INV_LAND, width: 40, sortable: false, editable: true, align: "center"},
                {label: "长", name: INV_LEN, width: 45, sortable: false, editable: true, align: "center"},
                {label: "宽", name: INV_WIDTH, width: 40, sortable: false, editable: true, align: "center"},
                {label: "外径", name: INV_EXTERNAL_DIAMETER, width: 40, sortable: false, editable: true, align: "center"},
                {label: "内径", name: INV_INTERNAL_DIAMETER, width: 40, sortable: false, editable: true, align: "center"},
                {label: "密度", name: INV_DENSITY, width: 40, sortable: false, editable: true, align: "center"},
                {label: "下料尺寸", name: INV_SIZE, width: 110, sortable: false, editable: true, align: "center"},
                {label: "单耗", name: IQTY, width: 45, sortable: false, editable: true, align: "center"},
                {label: "总量", name: TQTY, width: 45, sortable: false, editable: false, align: "center"},
                {label: "单位", name: INV_UNIT,hidden: true },
                {label: "部件编码", name: PART_INV_CODE,hidden: true, width: 110, sortable: false, editable: true, align: "center"},
                {label: "部件名称", name: PART_INV_NAME,hidden: true, width: 90, sortable: false, editable: false, align: "center"},
                {label: "规格型号", name: PART_INV_STD, hidden: true,width: 80, sortable: false, editable: false, align: "center"},
                {label: "单位", name: PART_INV_UNIT, hidden: true,width: 40, sortable: false, editable: false, align: "center"},
                {label: "部件数量", name: PART_QTY,hidden: true, width: 70, sortable: false, editable: true, align: "center"},
                {name: ROW_ID, hidden: true},
                {name: MAIN_ID, hidden: true},
            ],
            viewrecords: true,
            multiselect: false,
            autowidth: true,
            shrinkToFit: false,
            autoScroll: true,
            scrollrows: true, // 是否显示行滚动条
            rownumbers: true,
            rowNum: 999999999,
            colMenu: false,
            cellEdit: true,
            cellsubmit: 'clientArray',
            footerrow: false,//分页上添加一行，用于显示统计信息
            beforeProcessing: function (data, st, xhr) {//登录失效时请求将被拦截，提示用户：未登录
                if (data.success == false) {
                    layer.msg(data.msg);
                }
                return true;
            },
            loadBeforeSend: function (jqXHR) {
                var token = sessionStorage.getItem("mestoken");
                jqXHR.setRequestHeader('Authorization', token);

            },
            ondblClickRow: function (rowid, iRow, iCol, e) {
                //iCol==6||

                if (iCol == 14 || iCol == 12) {
                    chooseInvType = 'material';
                    //选择自建
                    choice(rowid);
                }
            },

            loadComplete: function () {


            },
            afterSaveCell: function (rowid, name, val, iRow, iCol) {
                console.log("保存单元格name:"+name);
                   if (CurRow != "" && CurRow != undefined) {
                       $("#jqGrid").jqGrid('saveCell', CurRow, CurCol);
                   }
                if (name == INV_CODE) {
                     SetInventory(rowid, "2");
                } else if (name == UNIT_MATERIAL_PRICE ||  name == UNIT_MATERIAL_AMOUNT ||name == INV_LAND || name == INV_LEN || name == INV_WIDTH || name == INV_EXTERNAL_DIAMETER || name == INV_INTERNAL_DIAMETER || name == INV_DENSITY ) {
                    //更新单耗
                    updateIqty(rowid);
                    //更新下料尺寸
                    updateInvSize(rowid);
                } else if (name == IQTY) {
                    <!--DATE: 2022/9/14-->
                    <!--mijiahao TODO:更新单耗后？ -->
                     afterUpdatingIqty(rowid);
                }

            },
            onCellSelect: function (rowid, iCol, cellcontent, e) { //单击选择行


            },
            beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
                CurRow1 = iRow;
                CurCol1 = iCol;


            },
            gridComplete: function () {

            }
        });

        $("#jqGridDetail").setGridHeight(($(window).outerHeight() - $(".weadmin-body").height() - 300));
    }

    //行id，当有增行操作时+1
    var irowid = 0;



    /*
     * 点击按钮产品表增行事件
     */
    function btnAddProductRow() {
        let productObj = new omMesProduct();
        productObj.setPlanStartDate(planStartDate);
        productObj.setPlanEndDate(planEndDate);
        productObj.setRecordId("r"+productMaxId);
        productHelper.saveCell(CurRow,CurCol);
        addProductRow(productObj);
    }

    /*
     * 产品表增行
     */
    function addProductRow(rowData){
        console.log("产品表增行");
        let productObj = new omMesProduct();
        productObj.setEntity(rowData);
        productObj.setTaxRate(DEFAULT_TAX_TATE);
        productObj.setRowId(productMaxId);
        productHelper.addRowData(productMaxId,productObj);
        productMaxId++;
    }


    //修改单耗后同步修改总量
    function afterUpdatingIqty(rowid) {
        console.log("修改单耗后同步修改总量");
        let materialObj = new omMesMaterial();
        materialObj.setEntity(materialHelper.getRowDataById(rowid));
        //数量
        let productQty = getStringDecimal(materialObj.getProductQty());
        //单耗
        let iqty = getStringDecimal(materialObj.getIqty());
        materialObj.setTqty((productQty * iqty).toFixed(2));
        console.log(materialObj);
        materialHelper.setRowDataById(rowid,materialObj);

    }

    /*
     * 点击材料表增行按钮事件
     */
    function addMaterialRowEvent(){

        productHelper.saveCell(CurRow,CurCol);
        //获取产品表选中行数据
        let productSelectedRowData = productHelper.getSelectedRowData();
        let materialObj = new omMesMaterial();
        materialObj.setEntity(productSelectedRowData);
        addMaterialRow(materialObj);
    }

    /*
     * 材料表增行
     */
    function addMaterialRow(row){
        row.rowId = materialMaxId;
        materialHelper.addRowData(materialMaxId,row);
        materialMaxId++;
    }


    //产品编码
    function choice(rowid) {
        if (rowid != null && rowid != '') {
            WeAdminShow('选择产品', '/components/choiceinventory.html?');
        } else {
            layer.alert("请先选择行再操作！");
        }
    }

    /*
   * 将partDataMap转换成array
   */
    function convertPartDataMapToArray(){
        let partDataArray = [];
        for ([key,value] of partDataMap){
            let array = value;
            array.forEach(function (row){
                partDataArray.push(row);
            })
        }
        return partDataArray;
    }

    /*
     * 选择产品信息回调函数
     */
    function chooseInventoryCallBack(u8Data){
        //根据选择物料类型来为产品表或材料表赋值，不算优雅的设计，但受限于框架没有更好的实现方式
        switch (chooseInvType) {
            case 'product':
                productHelper.saveCell(CurRow,CurCol);
                materialHelper.saveCell(CurRow1,CurCol1);
                let mesProduct = new omMesProduct();
                mesProduct.setEntity(productHelper.getSelectedRowData());
                //获取产品表选中行数据
                mesProduct.setDataFromU8Data(u8Data);
                //设置产品表当前行数据
                productHelper.setSelectedRowData(mesProduct);
                //同步设置材料表相关联的行数据
                let selectedProductRowData = productHelper.getSelectedRowData();
                let partIdArray = materialHelper.getAllRowsId();
                partIdArray.forEach(function (id) {
                    let rowData = materialHelper.getRowDataById(id);
                    if (rowData.recordId === selectedProductRowData.recordId){
                        materialHelper.setSelectedRowData(mesProduct);
                    }
                })
                break;
            case 'material':
                materialHelper.saveCell(CurRow1,CurCol1);
                let selectedMaterialRow = materialHelper.getSelectedRowData();
                let materialObj = new omMesMaterial();
                materialObj.setEntity(selectedMaterialRow);
                var iprice=0;
                $.ajax({
                    type: "post",
                    async: false,
                    dataType: "json",
                    url: "/basicinfo/inventory/getprice",
                    data: {cinvcode:u8Data.cinvcode},
                    success: function (data) {
                        iprice=parseFloat(data- 0).toFixed(2);
                        u8Data.cdefine26 = iprice;
                        //转换u8字段
                        materialObj.setMaterialInfoFromU8Data(u8Data);
                        //选中记录赋值
                        materialHelper.setSelectedRowData(materialObj);
                        sumMaterialPriceToProduct(materialObj.getRecordId())

                    },

                });

                break;
            default:
                break
        }


    }

    /*
     * 添加部件点击事件
     */
    function addPart(){
        console.log("打开添加部件窗口");
        productHelper.saveCell(CurRow,CurCol);
        let id = productHelper.getSelectedRowId();
        if (id === undefined){
            return;
        }
        //产品信息
        let productData = productHelper.getSelectedRowData();
        //当前产品的部件信息
        let partList = partDataMap.get(getPartTableId(id));
        //当前产品部件的材料信息
        let materialList = [];
        if (partList != null){
            partList.forEach(function (part) {
                let partRowId = part.partRowId;
                let allMaterial = materialHelper.getAllRowData();
                allMaterial.forEach(function (material) {
                    if (partRowId === material.partRowId){
                        materialList.push(material);
                    }
                })
            })
        }

        let param = {
            productData:productData,
            partList:partList,
            materialList:materialList
        }
        addPartParams = param;
        WeAdminShow('添加部件','./addpart.html');
    }

    /*
     * 增加部件表回调函数
     * @param product,产品表记录信息
     * @param partArray,部件记录数组
     * @param materialArray,材料记录数组
     * @param otherParams,其它参数
     */
    function addPartCallBack(product,partArray,materialArray,otherParams){
        //产品表赋值
        productHelper.setSelectedRowData(product)
        //部件表赋值
        let partTableId = getPartTableId(productHelper.getSelectedRowId());
        console.log("增加部件表-部件赋值-部件表id："+partTableId);
        partDataMap.set(partTableId,partArray);
        array = partArray;
        let productObj = new omMesProduct();
        productObj.setEntity(product);
        //合计该产品下所有材料的材料单价和单件材料费
        sumMaterialPriceToProduct(productObj.getRecordId())
        console.log("增加部件表-带回材料表数据↓");
        console.log(materialArray);
        //删除材料表中partRowId已存在的记录
        console.log("增加部件表-删除材料表中partRowId已存在的记录");
        //先删除
        materialArray.forEach(function (newMaterial){
            let allOldMaterial = materialHelper.getAllRowData();
            allOldMaterial.forEach(function (oldMaterial) {
                if (newMaterial.partRowId === oldMaterial.partRowId){
                    materialHelper.deleteRowById(oldMaterial.rowId)
                }
            })
        })
        //再增行
        materialArray.forEach(function (material) {
            addMaterialRow(material);
        })
    }

    /*
     * 获取部件表ID
     */
    function getPartTableId(rowId){
        let tableId = "jqGrid_"+rowId+"_t";
        return tableId;
    }

    <!--DATE: 2022/9/12-->
    <!--mijiahao TODO:没懂 -->
    //设置存货信息
    function SetInventory(rowid, itype) {
        console.log("设置存货信息");
        if (itype == "1") {
            var rowData = $("#jqGrid").jqGrid('getRowData', rowid);
            let productObj = new omMesProduct();
            productObj.setEntity(productHelper.getRowDataById(rowid));
            let query = new U8QueryDTO(productObj);
            $.ajax({
                type: "get",
                async: false,
                url: "/om/metalworkcommittee/gethistorybycinvcode1",
                data: query,
                success: function (data) {
                    if (data["mData"] != null && data["mData"] != "") {
                        data["mData"].recordId = productObj.getRecordId();
                        productHelper.setRowDataById(rowid,data["mData"])
                        var ids = materialHelper.getAllRowsId();
                        var izExist = false;
                        let materialObj = new omMesMaterial();
                        for (var i = 0; i < ids.length; i++) {
                            materialObj.setEntity(materialHelper.getRowDataById(ids[i]))
                            if (materialObj.getRecordId() == productObj.getRecordId()) {
                                izExist = true;
                                materialObj.setProductInfoFromU8Data(data["mData"])
                                materialHelper.setRowDataById(ids[i],materialObj);
//                                    $("#jqGridDetail").jqGrid("delRowData", ids[i]);
                            }
                        }
                        <!--DATE: 2022/9/13-->
                        <!--mijiahao TODO:不涉及字段操作，没问题，但待修改 -->
                        if (izExist == false) {
                            if (data["mDatas"] != null && data["mDatas"] != "") {
                                var gridData = $("#jqGridDetail").jqGrid("getRowData");
                                for (var i = 0; i < data["mDatas"].length; i++) {
                                    data["mDatas"][i].recordId = rowData.recordId;
                                    irowid = irowid + 1;
                                    $("#jqGridDetail").jqGrid("addRowData", irowid, data["mDatas"][i]);


                                }
                            }


                        }


                    }


                },
            });
        } else {
            let query = new U8QueryDTO(materialHelper.getRowDataById(rowid));
            $.ajax({
                type: "get",
                async: false,
                url: "/basicinfo/inventory/getbyid",
                data: query,
                success: function (data) {
                    if (data != null && data != "") {
                        data.cdefine26 = parseFloat(data.iinvncost - 0).toFixed(2);
                        let materialObj = new omMesMaterial();
                        materialObj.setEntity(materialHelper.getRowDataById(rowid));
                        materialObj.setMaterialInfoFromU8Data(data);
                        materialHelper.setRowDataById(rowid,materialObj);
                    } else {
                        materialHelper.setRowDataById(rowid,new omMesMaterial());
                    }

                },
            });
            updateInvSize(rowid);
        }


    }


    //------字段更新函数链-----

    /*
     * 更新产品表合计字段
     */
    function updateAmount(rowId){
        console.log("更新产品表合计字段");
        let productRow = productHelper.getRowDataById(rowId);
        let productObj = new omMesProduct();
        productObj.setEntity(productRow);
        let price = getStringDecimal(productObj.getPrice());
        let productQty = getStringDecimal(productObj.getProductQty());
        productObj.setEntity(productRow);
        productObj.setAmount((price * productQty).toFixed(2));
        productHelper.setRowDataById(rowId,productObj);
    }

    //修改数量后，同步更新其它字段
    function updateProductQty(rowid) {
        //更新加工费合计
        updateTotalWorkAmount(rowid);
        //更新合计
        updateAmount(rowid);
        //同步更新该产品下材料的数量字段
        let product = new omMesProduct();
        product.setEntity(productHelper.getRowDataById(rowid));
        let productQty = getStringDecimal(product.getProductQty());
        let ids = materialHelper.getAllRowsId();
        for (let i = 0; i < ids.length; i++) {
            let productMaterialRow = materialHelper.getRowDataById(ids[i]);
            let productMaterialObj = new omMesMaterial();
            productMaterialObj.setEntity(productMaterialRow);
            if (productMaterialObj.getRecordId() === product.getRecordId()) {
                //数量初始化
                let materialQty = getStringDecimal(productQty);
                //单耗初始化
                let iqty = getStringDecimal(0);
                //同步材料表数量
                productMaterialObj.setProductQty(materialQty);
                //计算材料表总量
                productMaterialObj.setTqty((materialQty * iqty).toFixed(2));
                console.log(productMaterialObj);
                materialHelper.setRowDataById(ids[i],productMaterialObj);
            }


        }
    }

    /*
     * 更新加工费合计字段
     */
    function updateTotalWorkAmount(rowId){
        let productRow = productHelper.getRowDataById(rowId);
        let productObj = new omMesProduct();
        productObj.setEntity(productRow);
        let productQty = getNumberDecimal(productObj.getProductQty());
        let price = getNumberDecimal(productObj.getPrice());
        let totalWorkAmount =( productQty * price).toFixed(2);
        productObj.setTotalWorkAmount(totalWorkAmount);
        productHelper.setRowDataById(rowId,productObj);
    }

    /*
     * 合计某产品下所有材料的材料单价和单件材料费
     */
    function sumMaterialPriceToProduct(recordId){
        if (recordId === undefined){
            layer.alert("recordId不能为空");
            return;
        }
        //查询对应的产品记录
        var idsMain = productHelper.getAllRowsId();
        var rowMainId = "";
        var rowMain = new omMesProduct();
        for (let i = 0; i < idsMain.length; i++) {
            var rowData1 = $("#jqGrid").getRowData(idsMain[i]);
            if (rowData1.recordId == recordId) {
                rowMainId = idsMain[i];
                rowMain.setEntity(rowData1);
                break;
            }
        }
        //循环子表合计材料单价和单件材料费
        var totalUnitMaterialPrice = 0, totalUnitMaterialAmount = 0;
        var ids = materialHelper.getAllRowsId();
        let materialObjForTotalPrice = new omMesMaterial();
        for (var i = 0; i < ids.length; i++) {
            let materialRow = materialHelper.getRowDataById(ids[i]);
            materialObjForTotalPrice.setEntity(materialRow);
            if (materialRow.recordId ===recordId) {
                totalUnitMaterialPrice = totalUnitMaterialPrice + parseFloat(materialObjForTotalPrice.getUnitMaterialPrice() - 0);
                totalUnitMaterialAmount = totalUnitMaterialAmount + parseFloat(materialObjForTotalPrice.getUnitMaterialAmount() - 0);
            }
        }

        if (rowMain != null) {
            //单件加工费
            let workPrice = getStringDecimal(rowMain.getWorkPrice())
            var price = ((totalUnitMaterialAmount - 0) + (workPrice - 0)) - 0;
            rowMain.setMaterialPrice(totalUnitMaterialPrice.toFixed(2));
            rowMain.setMaterialAmount(totalUnitMaterialAmount.toFixed(2));
            rowMain.setPrice(price);
            rowMain.setAmount((price * rowMain.getProductQty).toFixed(2));
            productHelper.setRowDataById(rowMainId,rowMain);
            //更新单件价格字段
            updatePrice(rowMainId)
        }
    }

    /*
     * 更新单件价格字段
     */
    function updatePrice(rowId){
        let productRow = productHelper.getRowDataById(rowId);
        let productObj = new omMesProduct();
        productObj.setEntity(productRow);
        let materialAmount = getNumberDecimal(productObj.getMaterialAmount());
        let workPrice = getNumberDecimal(productObj.getWorkPrice());
        productObj.setPrice(materialAmount+workPrice)
        productHelper.setRowDataById(rowId,productObj);
        updateAmount(rowId);
    }

    /*
     * 更新单耗字段
     */
    function updateIqty(rowId){
        console.log("更新单耗字段");
        let rowData = materialHelper.getRowDataById(rowId);
        let materialObj = new omMesMaterial();
        materialObj.setEntity(rowData);
        //长
        let invLen = getStringDecimal(materialObj.getInvLen());
        //厚
        let invLand = getStringDecimal(materialObj.getInvLand());
        //宽
        let invWidth = getStringDecimal(materialObj.getInvWidth());
        //外径
        let externalDiameter = getStringDecimal(materialObj.getInvExternalDiameter());
        //内径
        let internalDiameter = getStringDecimal(materialObj.getInvInternalDiameter());
        //密度
        let density = getStringDecimal(materialObj.getInvDensity());
        //计算单耗
        var iqty = ((invLen * invWidth + 3.1415926 / 4 * (externalDiameter * externalDiameter - internalDiameter * internalDiameter)) * invLand / 1000000 * density).toFixed(2) - 0;
        let query = new U8QueryDTO(materialObj);
        $.ajax({
            type: "get",
            async: false,
            url: "/basicinfo/inventory/getbyid",
            data: query,
            success: function (data) {
                if (data != null && data != "") {

                    if ((iqty == null || iqty == 0 || iqty == "0")) {
                        if (data.cinvdefine1 == "A" || data.cinvdefine1 == "a") {
                            iqty = parseFloat((invLand * invLen * invWidth * density / 1000000).toFixed(3));
                        } else if (data.cinvdefine1 == "B" || data.cinvdefine1 == "b") {
                            iqty = parseFloat((invLen * density * (externalDiameter * externalDiameter - internalDiameter * internalDiameter) * 3.1415926 / 4 / 1000000).toFixed(3));

                        } else if (data.cinvdefine1 == "C" || data.cinvdefine1 == "c") {
                            iqty = parseFloat((invLen / 1000).toFixed(3));
                        } else if (data.cinvdefine1 == "D" || data.cinvdefine1 == "d") {
                            iqty = parseFloat((invLen * invWidth / 1000000).toFixed(3));
                        } else if (data.cinvdefine1 == "E" || data.cinvdefine1 == "e") {
                            iqty = parseFloat((invLen / 1000).toFixed(3));
                        } else if (data.cinvdefine1 == "F" || data.cinvdefine1 == "f") {
                            iqty = parseFloat((invLand / 1000 * invLen / 1000 * invWidth / 1000 * 1).toFixed(3));
                        } else if (data.cinvdefine1 == "G" || data.cinvdefine1 == "g") {
                            iqty = parseFloat((invLen / 1000 * 1).toFixed(3));
                        }
                    }
                }
            },
        });
        materialObj.setIqty(iqty);
        materialHelper.setRowDataById(rowId,materialObj);
        updateUnitMaterialAmount(rowId);
    }

    /*
     * 更新单件材料费
     */
    function updateUnitMaterialAmount(rowid){
        let rowData = materialHelper.getRowDataById(rowid);
        let materialObj = new omMesMaterial();
        materialObj.setEntity(rowData);
        let unitMaterialPrice = getNumberDecimal(materialObj.getUnitMaterialPrice());
        let iqty = getNumberDecimal(materialObj.getIqty());
        let unitMaterialAmount = (unitMaterialPrice * iqty).toFixed(2);
        materialObj.setUnitMaterialAmount(unitMaterialAmount);
        materialHelper.setRowDataById(rowid,materialObj);
    }

    //设置下料尺寸
    function updateInvSize(rowid) {
        console.log("设置下料尺寸！");
        let rowData = materialHelper.getRowDataById(rowid);
        let materialObj = new omMesMaterial();
        materialObj.setEntity(rowData);
        //数量
        let productQty = getStringDecimal(materialObj.getProductQty());
        var strSize = "";
        //厚度
        let invLand = getStringDecimal(materialObj.getInvLand());
        if (invLand !== 0){
            strSize = "δ" + materialObj.getInvLand();
        }
        //长
        let invLen = getStringDecimal(materialObj.getInvLen());
        if (invLen !== 0){
            if (strSize != "") {
                strSize = strSize + ",";
            }
            strSize = strSize + "L" + materialObj.getInvLen();
        }
        //宽
        let invWidth = getStringDecimal(materialObj.getInvWidth());
        if (invWidth !== 0){
            if (strSize != "") {
                strSize = strSize + ",";
            }
            strSize = strSize + "W" + materialObj.getInvWidth();
        }
        //外径
        let externalDiameter = getStringDecimal(materialObj.getInvExternalDiameter());
        if (externalDiameter !== 0){
            if (strSize != "") {
                strSize = strSize + ",";
            }
            strSize = strSize + "外φ" + materialObj.getInvExternalDiameter();
        }
        //内径
        let internalDiameter = getStringDecimal(materialObj.getInvInternalDiameter());
        if (internalDiameter !== 0){
            if (strSize != "") {
                strSize = strSize + ",";
            }
            strSize = strSize + "内φ" + materialObj.getInvExternalDiameter();
        }
        //密度
        let density = getStringDecimal(materialObj.getInvDensity());

        var iqty = ((invLen * invWidth + 3.1415926 / 4 * (externalDiameter * externalDiameter - internalDiameter * internalDiameter)) * invLand / 1000000 * density).toFixed(2) - 0;
        let query = new U8QueryDTO(materialObj);
        $.ajax({
            type: "get",
            async: false,
            url: "/basicinfo/inventory/getbyid",
            data: query,
            success: function (data) {
                if (data != null && data != "") {

                    if ((iqty == null || iqty == 0 || iqty == "0")) {
                        if (data.cinvdefine1 == "A" || data.cinvdefine1 == "a") {
                            iqty = parseFloat((invLand * invLen * invWidth * density / 1000000).toFixed(3));
                        } else if (data.cinvdefine1 == "B" || data.cinvdefine1 == "b") {
                            iqty = parseFloat((invLen * density * (externalDiameter * externalDiameter - internalDiameter * internalDiameter) * 3.1415926 / 4 / 1000000).toFixed(3));

                        } else if (data.cinvdefine1 == "C" || data.cinvdefine1 == "c") {
                            iqty = parseFloat((invLen / 1000).toFixed(3));
                        } else if (data.cinvdefine1 == "D" || data.cinvdefine1 == "d") {
                            iqty = parseFloat((invLen * invWidth / 1000000).toFixed(3));
                        } else if (data.cinvdefine1 == "E" || data.cinvdefine1 == "e") {
                            iqty = parseFloat((invLen / 1000).toFixed(3));
                        } else if (data.cinvdefine1 == "F" || data.cinvdefine1 == "f") {
                            iqty = parseFloat((invLand / 1000 * invLen / 1000 * invWidth / 1000 * 1).toFixed(3));
                        } else if (data.cinvdefine1 == "G" || data.cinvdefine1 == "g") {
                            iqty = parseFloat((invLen / 1000 * 1).toFixed(3));
                        }

                    }

                }


            },
        });


        //材料单价
        let unitMaterialPrice = getStringDecimal(materialObj.getUnitMaterialPrice());

        //单件材料费
        var unitMaterialAmount = ((iqty - 0) * (unitMaterialPrice - 0)).toFixed(2);
        materialObj.setInvSize(strSize);
        materialObj.setUnitMaterialAmount(unitMaterialAmount);
        materialObj.setIqty(iqty)
        materialObj.setTqty((iqty * productQty).toFixed(2));
        materialHelper.setRowDataById(rowid,materialObj)
        //循环子表合计材料单价和单件材料费
        sumMaterialPriceToProduct(materialObj.getRecordId());

    }

    /*
     * 产品表删行
     */
    function deleteProductRow(){
        //保存正在编辑的单元格
        productHelper.saveCell(CurRow,CurRow);
        let selectedProductData = productHelper.getSelectedRowData();
        if (selectedProductData === undefined){
            return;
        }
        let ableToDelete = true;
        let dataArray = materialHelper.getAllRowData();
        dataArray.forEach(function (material) {
            if (material.recordId === selectedProductData.recordId){
                layer.alert("请先删除该产品下的材料表记录");
                ableToDelete = false;
                return;
            }
        })
        if (ableToDelete){
            productHelper.deleteSelectedRow();
        }
    }

    /*
     * 材料表删行
     */
    function deleteMaterialRow(){
        //保存正在编辑的单元格
        materialHelper.saveCell(CurRow1,CurCol1);
        let selectedRowId = materialHelper.getSelectedRowId();
        if (selectedRowId === undefined){
            return;
        }
        let selectedRowData = materialHelper.getRowDataById(selectedRowId);
        materialHelper.deleteSelectedRow();
        //循环子表合计材料单价和单件材料费
        sumMaterialPriceToProduct(selectedRowData.recordId);

    }

    /*
     * 清空所有数据
     */
    function clearAllData(){
        console.log("重新加载所有数据");
        productMaxId = 1;
        materialMaxId = 1;
        partMaxId = 1;
        let allMaterialId = materialHelper.getAllRowsId();
        //清空材料数据
        allMaterialId.forEach(function (id) {
            materialHelper.deleteRowById(id)
        })
        //清空产品数据
        let allProductId = productHelper.getAllRowsId()
        allProductId.forEach(function (id) {
            productHelper.deleteRowById(id)
        })
        //清空部件数据
        partDataMap.clear();
    }

    /*
     * 根据主表ID加载所有数据
     */
    function loadAllDataByMainId(){
        console.log("根据主表ID加载所有数据");
        clearAllData();
        let id = $("#id").val();
        sendGetReq(URL_GET_ALL_MAIN_DATA_BY_ID, {id: id}, function (result) {
            let data = result.data;
            if (data != null){
                console.log("初始化数据-主表赋值");
                $("form").setForm(data.main);
                layui.form.render();
                let productList = data.productList;
                let partList = data.partList;
                let materialList = data.materialList;
                //添加产品数据
                productList.forEach(function (product) {
                    addProductRow(product);
                })
                //为每条产品设置对应的部件记录
                let allProductRow = productHelper.getAllRowData();
                allProductRow.forEach(function (productRow) {
                    let productObj = new omMesProduct();
                    productObj.setEntity(productRow);
                    let partTableId = getPartTableId(productObj.getRowId());
                    let partArray = [];
                    let partObj = new omMesPart();
                    //找出部件记录中部件ID和产品ID相同的记录
                    partList.forEach(function (part) {
                        partObj.setEntity(part)
                        if (partObj.getDetailId() === productObj.getId()){
                            partArray.push(part);
                        }
                    })
                    partDataMap.set(partTableId,partArray);
                })
                //添加材料数据
                materialList.forEach(function (material) {
                    addMaterialRow(material);
                })
            }
        });
    }





</script>
</html>